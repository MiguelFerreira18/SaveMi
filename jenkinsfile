def execCommand(command){
    if(isUnix()){
        sh command
    }else{
        bat command
    }
}
pipeline{
  agent any

  environment {
        branch = 'main'
        repo = 'https://github.com/MiguelFerreira18/SaveMi'
        DOCKERHUB_ID = 'miguelferreiraa'
        DOCKER_SAVEMI_BACKEND = 'savemi-be'
        DOCKER_SAVEMI_FRONTEND = 'savemi-fe'
        tag = 'latest'
        DOCKERHUB_CREDENTIALS = credentials('savemi-docker')
        PROFILE='prod'
    }
 stages {
        stage('Checkout') {
            steps{
                checkout scm
                }
        }
        stage('Build Spring Boot jar'){
            steps{
                dir('./'){
                    execCommand('mvn clean package -DskipTests')
                }
            }
        }
        stage('Build Spring Boot dockerfile'){
            steps{
                dir('./'){
                    execCommand("docker build -t ${DOCKERHUB_ID}/${DOCKER_SAVEMI_BACKEND}:${tag} .")
                }
            }
        }
        stage('Install node dependencies'){
          steps {
            execCommand('npm install -g @angular/cli')
            execCommand('npm install')
          }
        }
        stage('Build Angular'){
          steps{
            dir('publicA'){
              execCommand('ng build --configuration ${PROFILE}')
            }
          }
        }
        stage('Build Angular dockerfile'){
          steps{
            dir('publicA'){
              execCommand('docker build --build-arg PROFILE=${localP} -t ${DOCKERHUB_ID}/${DOCKER_SAVEMI_FRONTEND}:${TAG} .')
            }
          }
        }
        stage('Login to Dockerhub'){
            steps{
                withCredentials([usernamePassword(credentialsId: 'saveme-docker', passwordVariable: 'DOCKERHUB_PASSWORD', usernameVariable: 'DOCKERHUB_NAME')]) {
                    execCommand("docker login -u ${DOCKERHUB_NAME} -p ${DOCKERHUB_PASSWORD}")
                }
            }
        }
        stage('Push Backend to Dockerhub'){
            steps{
                dir('./'){
                    execCommand("docker push ${DOCKERHUB_ID}/${DOCKER_SAVEMI_BACKEND}:${tag}")
                }
            }
        }
        stage('Push Frontend to Dockerhub'){
            steps{
                dir('publicA'){
                    execCommand("docker push ${DOCKERHUB_ID}/${DOCKER_SAVEMI_FRONTEND}:${tag}")
                }
            }
        }
    }
    post {
        always {
            execCommand('docker logout')
            cleanWs()

        }
    }
}
